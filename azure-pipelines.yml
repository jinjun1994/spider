# Node.js with Vue
# Build a Node.js project that uses Vue.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'

- script: |
    cd vue-spider
    npm install
    npm run build
    cd ../egg
    npm install --production
    tar -zcvf egg.tar.gz egg
    tar -zcvf spider.tar.gz vue-spider/spider
  displayName: 'npm install and build'
- task: CopyFilesOverSSH@0
  inputs:
    sshEndpoint: '149.248.5.21'
    sourceFolder: 'spider.tar.gz'
    contents: '**'
    targetFolder: '/home/wwwroot/jizhi.jinjun.wiki/spider.tar.gz'
    readyTimeout: '20000'
- task: CopyFilesOverSSH@0
  inputs:
    sshEndpoint: '149.248.5.21'
    sourceFolder: 'egg.tar.gz'
    contents: '**'
    targetFolder: '/home/wwwroot/jizhi.jinjun.wiki/egg.tar.gz'
    readyTimeout: '20000'

- task: SSH@0
  inputs:
    sshEndpoint: '149.248.5.21'
    runOptions: 'inline'
    inline: |
      tar -zxvf spider.tar.gz
      tar -zxvf egg.tar.gz
      cd /home/wwwroot/jizhi.jinjun.wiki/egg
      npm stop 
      npm start
    readyTimeout: '20000'